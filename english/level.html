<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>English Level Check ‚Üí Cartoons (Adaptive + Saved)</title>
  <meta name="description" content="Computer-adaptive English test (one question at a time). No math/counting. Stops early when confidence is high. After the test: watching rules + 10+ cartoons for your level. Saves result." />

  <!-- Better font -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800;900&display=swap" rel="stylesheet">

  <!-- Bootstrap 5.0.2 -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">

  <style>
    :root{
      --bg1:#0b1220; --bg2:#0f1b32;
      --line:rgba(148,163,184,.22);
      --text:#e5e7eb; --muted:#94a3b8;
      --accent:#22c55e; --accent2:#60a5fa;
      --danger:#ef4444;
      --shadow: 0 12px 30px rgba(0,0,0,.25);
      --radius: 18px;
    }
    html{scroll-behavior:smooth}
    body{
      font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background:
        radial-gradient(1200px 800px at 10% 0%, rgba(96,165,250,.14), transparent 55%),
        radial-gradient(900px 700px at 100% 10%, rgba(34,197,94,.12), transparent 52%),
        linear-gradient(180deg, var(--bg1), var(--bg2));
      color: var(--text);
    }
    .navbar{
      backdrop-filter: blur(10px);
      background: rgba(11,18,32,.72)!important;
      border-bottom: 1px solid var(--line);
    }
    .brand-dot{
      width:12px;height:12px;border-radius:999px;
      background: linear-gradient(135deg, var(--accent), rgba(96,165,250,.85));
      display:inline-block;margin-right:10px;box-shadow:0 0 0 4px rgba(34,197,94,.10);
    }
    .hero-card{
      background: linear-gradient(180deg, rgba(15,23,42,.78), rgba(15,23,42,.62));
      border: 1px solid var(--line);
      border-radius: calc(var(--radius) + 6px);
      box-shadow: var(--shadow);
      overflow:hidden;
      position:relative;
    }
    .hero-card:before{
      content:"";
      position:absolute; inset:-2px;
      background:
        radial-gradient(700px 260px at 15% 10%, rgba(34,197,94,.20), transparent 60%),
        radial-gradient(700px 260px at 85% 0%, rgba(96,165,250,.18), transparent 60%);
      pointer-events:none;
    }
    .hero-inner{ position:relative; padding: 16px; }

    .card-x{
      background: rgba(15,23,42,.68);
      border: 1px solid var(--line);
      border-radius: var(--radius);
      box-shadow: 0 10px 22px rgba(0,0,0,.18);
    }
    .muted{ color: var(--muted); }
    .tiny{ font-size:.95rem; }

    .pill{
      display:inline-flex; align-items:center; gap:.5rem;
      padding: .35rem .7rem;
      border-radius: 999px;
      border: 1px solid var(--line);
      background: rgba(2,6,23,.35);
      color: var(--muted);
      font-size:.92rem;
      margin-right:.4rem;
      margin-bottom:.4rem;
      user-select:none;
      white-space:nowrap;
    }
    .pill b{ color: var(--text); font-weight:900; }

    .btn-accent{
      background: linear-gradient(135deg, rgba(34,197,94,.95), rgba(96,165,250,.85));
      border: 0;
      color: #0b1220;
      font-weight: 950;
      box-shadow: 0 10px 22px rgba(34,197,94,.18);
    }
    .btn-accent:hover{ filter: brightness(1.05); color:#0b1220; }
    .btn-soft{
      background: rgba(2,6,23,.35);
      border: 1px solid var(--line);
      color: var(--text);
      font-weight: 850;
    }
    .btn-soft:hover{ background: rgba(2,6,23,.55); color: var(--text); }

    .progress{
      height: 10px;
      background: rgba(148,163,184,.16);
      border-radius: 999px;
      overflow: hidden;
    }
    .progress-bar{
      background: linear-gradient(90deg, rgba(96,165,250,.95), rgba(34,197,94,.95));
    }
    .soft-line{ border-top:1px solid var(--line); }

    .qwrap{
      border: 1px solid var(--line);
      border-radius: 16px;
      background: rgba(2,6,23,.30);
      padding: 14px;
    }
    .badge-soft{
      border:1px solid var(--line);
      background: rgba(2,6,23,.35);
      color: var(--text);
      border-radius:999px;
      padding:.25rem .6rem;
      font-weight:950;
    }
    .badge-ok{ border-color: rgba(34,197,94,.35); }
    .badge-mid{ border-color: rgba(245,158,11,.35); }
    .badge-hard{ border-color: rgba(239,68,68,.35); }

    .q-title{
      font-weight: 950;
      letter-spacing: .2px;
      font-size: clamp(18px, 3.6vw, 22px);
      line-height: 1.25;
      margin: 0;
    }
    .q-sub{ color: var(--muted); font-size:.95rem; margin-top:6px; }

    .story{
      border: 1px solid rgba(148,163,184,.25);
      background: rgba(15,23,42,.55);
      border-radius: 16px;
      padding: 12px 12px;
      font-size: 1.03rem;
      line-height: 1.6;
      white-space: pre-wrap;
      margin-top: 10px;
    }

    .ans-btn{
      width: 100%;
      text-align: left;
      border-radius: 14px;
      border: 1px solid var(--line);
      background: rgba(255,255,255,.03);
      color: var(--text);
      padding: 12px 14px;
      font-weight: 850;
      transition: transform .06s ease, filter .06s ease;
    }
    .ans-btn:hover{ filter: brightness(1.04); transform: translateY(-1px); }
    .ans-btn:disabled{ opacity: .72; transform:none; }
    .ans-correct{ border-color: rgba(34,197,94,.55)!important; background: rgba(34,197,94,.10)!important; }
    .ans-wrong{ border-color: rgba(239,68,68,.55)!important; background: rgba(239,68,68,.10)!important; }

    .note{
      border: 1px dashed rgba(148,163,184,.35);
      border-radius: 16px;
      padding: 12px;
      background: rgba(2,6,23,.24);
    }

    .show-card{
      border: 1px solid var(--line);
      border-radius: 16px;
      background: rgba(2,6,23,.30);
      padding: 14px;
      height: 100%;
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    .show-card .title{ font-weight:950; letter-spacing:.2px; line-height:1.15; }
    .show-card .desc{ color: var(--muted); font-size:.95rem; margin:0; }

    .toast-mini{
      display:none;
      position: fixed;
      left: 50%;
      transform: translateX(-50%);
      bottom: 18px;
      z-index: 1000;
      border: 1px solid var(--line);
      background: rgba(2,6,23,.80);
      color: var(--text);
      padding: 10px 12px;
      border-radius: 999px;
      backdrop-filter: blur(8px);
      max-width: min(92vw, 560px);
      box-shadow: 0 12px 30px rgba(0,0,0,.28);
      font-weight: 850;
    }

    @media (max-width: 576px){
      .hero-inner{ padding: 14px; }
      .ans-btn{ padding: 12px 12px; }
    }
  </style>
</head>

<body>
  <nav class="navbar navbar-expand-lg navbar-dark sticky-top">
    <div class="container">
      <a class="navbar-brand fw-bold" href="#">
        <span class="brand-dot"></span>
        Adaptive Level Check ‚Üí Cartoons
      </a>

      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navMain"
              aria-controls="navMain" aria-expanded="false" aria-label="Menu">
        <span class="navbar-toggler-icon"></span>
      </button>

      <div class="collapse navbar-collapse" id="navMain">
        <div class="ms-auto d-flex gap-2 py-2 py-lg-0">
          <button class="btn btn-soft btn-sm" id="btnShowSaved" type="button">Show saved</button>
          <button class="btn btn-soft btn-sm" id="btnRestart" type="button">New test</button>
          <button class="btn btn-soft btn-sm" id="btnClear" type="button">Clear cache</button>
        </div>
      </div>
    </div>
  </nav>

  <div class="container py-4">
    <div class="hero-card mb-3">
      <div class="hero-inner">
        <div class="d-flex flex-wrap gap-2 align-items-center justify-content-between">
          <div>
            <div class="pill">‚úÖ <b>English only</b></div>
            <div class="pill">üö´ <b>no math / no counting</b></div>
            <div class="pill">üéØ stops early when <b>confidence</b> is high</div>
            <div class="pill">üíæ saved result</div>
          </div>
          <button class="btn btn-accent" id="btnStart" type="button">Start</button>
        </div>

        <h1 class="h4 fw-bold mt-3 mb-1">One question at a time (computer-adaptive)</h1>
        <div class="muted tiny">
          The test adapts. It chooses the next question based on your current estimated level and stops early when it‚Äôs confident.
        </div>

        <div class="muted tiny mt-2" id="savedHint" style="display:none;"></div>

        <div class="mt-3">
          <div class="progress">
            <div class="progress-bar" id="progressBar" style="width:0%"></div>
          </div>
          <div class="d-flex justify-content-between mt-2 tiny muted flex-wrap gap-2">
            <div id="progressText">0/0</div>
            <div id="accuracyText">accuracy: ‚Äî</div>
            <div id="confText">confidence: ‚Äî</div>
          </div>
        </div>
      </div>
    </div>

    <!-- TEST -->
    <div class="row g-3" id="testRow" style="display:none;">
      <div class="col-12 col-lg-7">
        <div class="card-x p-3 p-md-4">
          <div class="d-flex justify-content-between align-items-start gap-2 flex-wrap">
            <div class="d-flex align-items-center gap-2 flex-wrap">
              <span class="badge-soft" id="typeBadge">type: ‚Äî</span>
              <span class="badge-soft" id="estBadge">estimate: ‚Äî</span>
              <span class="badge-soft" id="sdBadge">¬± ‚Äî</span>
            </div>
            <button class="btn btn-soft btn-sm" id="btnSkip" type="button">I don‚Äôt know</button>
          </div>

          <hr class="soft-line my-3">

          <div class="qwrap">
            <p class="q-title" id="qTitle">‚Äî</p>
            <div class="q-sub" id="qSub">‚Äî</div>
            <div id="storyBox" class="story" style="display:none;"></div>
          </div>

          <div class="d-grid gap-2 mt-3" id="answersGrid"></div>

          <div class="note mt-3">
            <div class="fw-bold mb-1">Precision rule</div>
            <div class="muted tiny mb-0">
              If you‚Äôre not sure, hit ‚ÄúI don‚Äôt know‚Äù. The system will keep the cartoon recommendations in the right difficulty zone.
            </div>
          </div>
        </div>
      </div>

      <div class="col-12 col-lg-5">
        <div class="card-x p-3 p-md-4">
          <div class="fw-bold mb-2">What makes this ‚Äúadaptive‚Äù</div>
          <div class="muted tiny mb-0">
            It tries to ask questions where you have ~50% chance (that‚Äôs where we learn your level fastest).
            So you don‚Äôt need to answer all questions.
          </div>
        </div>
      </div>
    </div>

    <!-- RESULT -->
    <div class="row g-3" id="resultRow" style="display:none;">
      <div class="col-12">
        <div class="card-x p-3 p-md-4">
          <div class="d-flex justify-content-between align-items-end gap-2 flex-wrap">
            <div>
              <h2 class="h5 fw-bold mb-1">Your result</h2>
              <div class="muted tiny" id="resultMeta">‚Äî</div>
            </div>
            <div class="d-flex gap-2 flex-wrap">
              <button class="btn btn-soft" id="btnRetake" type="button">Retake</button>
              <button class="btn btn-accent" id="btnSaveNow" type="button">Save</button>
            </div>
          </div>

          <hr class="soft-line my-3">

          <div class="row g-3 mb-3">
            <div class="col-12 col-lg-4">
              <div class="qwrap h-100">
                <div class="fw-bold mb-1">Level</div>
                <div class="h3 fw-bold mb-1" id="levelName">‚Äî</div>
                <div class="muted tiny mb-0" id="levelExplain">‚Äî</div>
              </div>
            </div>
            <div class="col-12 col-lg-4">
              <div class="qwrap h-100">
                <div class="fw-bold mb-1">Confidence</div>
                <div class="h3 fw-bold mb-1" id="finalConf">‚Äî</div>
                <div class="muted tiny mb-0" id="finalSD">‚Äî</div>
              </div>
            </div>
            <div class="col-12 col-lg-4">
              <div class="qwrap h-100">
                <div class="fw-bold mb-1">Accuracy</div>
                <div class="h3 fw-bold mb-1" id="finalAccuracy">‚Äî</div>
                <div class="muted tiny mb-0" id="finalCount">‚Äî</div>
              </div>
            </div>
          </div>

          <div class="note mb-3">
            <div class="fw-bold mb-2">Watching rules (short)</div>
            <div class="tiny">
              ‚Ä¢ Watch without subtitles (subtitles = reading, not listening).<br>
              ‚Ä¢ Target: 60‚Äì80% clear.<br>
              ‚Ä¢ Too hard ‚Üí go simpler. Too easy ‚Üí harder.<br>
              ‚Ä¢ Repeat the same episode 2‚Äì4 times.
            </div>
          </div>

          <div class="fw-bold mb-2">Cartoons (10+)</div>
          <div class="row g-3" id="recGrid"></div>
        </div>
      </div>
    </div>
  </div>

  <div class="toast-mini" id="toastMini">‚Äî</div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js"
          integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM"
          crossorigin="anonymous"></script>

  <script>
    // ============================
    // ADAPTIVE ENGINE (Bayesian grid)
    // - Each item has difficulty b on scale [-2.2..+2.2]
    // - We keep a posterior over theta (ability) and pick next item near posterior mean
    // - Stop early when posterior SD is small enough
    // ============================

    const KEY = "english_cartoon_levelcheck_v5_adaptive";
    const MIN_Q = 10;
    const MAX_Q = 26;
    const TARGET_SD = 0.38; // lower = more confident, more questions
    const A = 1.35; // discrimination

    // Utility: make unique IDs easier to manage
    const ITEM_BANK = [
      // ===== VERY EASY (b ~ -2.0..-1.4) =====
      {id:"e01", b:-2.0, type:"CLOZE", q:"I am ___.", a:"happy", opts:["happy","table","yellow","quickly"]},
      {id:"e02", b:-1.9, type:"CLOZE", q:"Please ___ the door.", a:"open", opts:["open","swim","laugh","paper"]},
      {id:"e03", b:-1.8, type:"CLOZE", q:"I drink ___.", a:"water", opts:["water","chair","blue","run"]},
      {id:"e04", b:-1.8, type:"CLOZE", q:"It is ___ outside. The sun is bright.", a:"sunny", opts:["sunny","angry","heavy","late"]},
      {id:"e05", b:-1.7, type:"TEXT_Q",
        story:`Tom is at the door. He cannot find his key.
He checks his pocket. Nothing.
Then he checks his bag and smiles.`,
        q:"Where was the key most likely?",
        a:"In his bag.",
        opts:["In his bag.","In the fridge.","On the roof.","In the sink."]},
      {id:"e06", b:-1.7, type:"TEXT_Q",
        story:`Anna feels cold. She closes the window.
Then she makes tea.`,
        q:"Why did Anna close the window?",
        a:"Because she felt cold.",
        opts:["Because she felt cold.","Because she was late.","Because she was hungry.","Because it was noisy music."]},
      {id:"e07", b:-1.6, type:"CLOZE", q:"This bag is very ___. I can lift it easily.", a:"light", opts:["light","deep","busy","sweet"]},
      {id:"e08", b:-1.5, type:"CLOZE", q:"I ___ with my friend after school.", a:"talk", opts:["talk","milk","green","push"]},
      {id:"e09", b:-1.5, type:"TEXT_Q",
        story:`Ben is thirsty. He looks at the empty bottle.
He goes to the kitchen.`,
        q:"What will Ben probably do?",
        a:"Get a drink.",
        opts:["Get a drink.","Go to sleep.","Buy a car.","Call the museum."]},

      // ===== EASY (b ~ -1.3..-0.6) =====
      {id:"m01", b:-1.3, type:"CLOZE", q:"Can I ___ your pen?", a:"borrow", opts:["borrow","invent","repair","divide"]},
      {id:"m02", b:-1.2, type:"CLOZE", q:"I didn‚Äôt go out because I felt ___.", a:"sick", opts:["sick","square","silent","exact"]},
      {id:"m03", b:-1.1, type:"TEXT_Q",
        story:`Mia looks for her phone.
It is not in her bag.
Then she sees it on the table.`,
        q:"Where was the phone?",
        a:"On the table.",
        opts:["On the table.","In her shoe.","In the car.","In the mailbox."]},
      {id:"m04", b:-1.0, type:"CLOZE", q:"He ___ his friend to the party.", a:"invited", opts:["invited","ignored","imagined","included"]},
      {id:"m05", b:-0.9, type:"TEXT_Q",
        story:`Grandpa drinks tea without sugar.
He says: ‚ÄúIf there‚Äôs lemon, I won‚Äôt add milk.‚Äù
Today there is lemon.`,
        q:"What will Grandpa add to his tea?",
        a:"Lemon (and no milk).",
        opts:["Sugar.","Milk.","Lemon (and no milk).","Salt."]},
      {id:"m06", b:-0.9, type:"CLOZE", q:"This movie is ___. It makes me laugh.", a:"funny", opts:["funny","empty","final","modern"]},
      {id:"m07", b:-0.8, type:"TEXT_Q",
        story:`Ava forgets her umbrella.
Outside, the sky is dark and windy.
She decides to stay inside.`,
        q:"Why does Ava stay inside?",
        a:"Because it might rain.",
        opts:["Because it might rain.","Because she loves wind.","Because it is too quiet.","Because she is at a museum."]},
      {id:"m08", b:-0.7, type:"CLOZE", q:"Please ___ me a message when you arrive.", a:"send", opts:["send","lend","bend","hide"]},
      {id:"m09", b:-0.6, type:"TEXT_Q",
        story:`Leo‚Äôs jacket is not on the chair.
He never puts it on the sofa when it‚Äôs wet, and it rained today.`,
        q:"Where is the jacket most likely?",
        a:"In his backpack.",
        opts:["On the sofa.","On the chair.","In his backpack.","On the roof."]},

      // ===== MID (b ~ -0.5..+0.5) =====
      {id:"a01", b:-0.5, type:"CLOZE", q:"I was late, so I ___ a taxi.", a:"took", opts:["took","taught","torn","tied"]},
      {id:"a02", b:-0.4, type:"CLOZE", q:"She apologized ___ being rude.", a:"for", opts:["for","to","at","by"]},
      {id:"a03", b:-0.3, type:"TEXT_Q",
        story:`Nora sees a ‚ÄúClosed‚Äù sign on the shop door.
She checks her watch and says, ‚ÄúOh, of course.‚Äù`,
        q:"What is most likely true?",
        a:"She arrived after closing time.",
        opts:["She arrived after closing time.","She forgot her name.","The shop moved to another city.","The door is broken forever."]},
      {id:"a04", b:-0.2, type:"CLOZE", q:"I‚Äôll call you ___ I finish work.", a:"when", opts:["when","where","who","why"]},
      {id:"a05", b:0.0, type:"TEXT_Q",
        story:`Tom buys a cheap umbrella. It breaks quickly.
Now he wants a stronger one, even if it costs more.`,
        q:"What will Tom probably do next?",
        a:"Buy a better umbrella.",
        opts:["Buy a better umbrella.","Stop walking.","Call the police.","Throw away his shoes."]},
      {id:"a06", b:0.1, type:"CLOZE", q:"He refused the offer, ___ it was a good deal.", a:"although", opts:["although","because","since","so"]},
      {id:"a07", b:0.2, type:"TEXT_Q",
        story:`Lina says, ‚ÄúI‚Äôm fine.‚Äù
But her voice is shaky, and she avoids eye contact.`,
        q:"What does this suggest?",
        a:"She may not be fine.",
        opts:["She may not be fine.","She is very hungry.","She is excited for a party.","She is reading a book."]},
      {id:"a08", b:0.3, type:"CLOZE", q:"Please ___ this email to your manager.", a:"forward", opts:["forward","freeze","float","forgive"]},
      {id:"a09", b:0.5, type:"TEXT_Q",
        story:`The teacher posts two essays on her desk.
One smells like fresh printer ink. The other has a faint coffee ring.
She said: ‚ÄúThe student who usually emails drafts forgot a laptop today and printed at the library just before class.‚Äù`,
        q:"Which essay likely belongs to that student?",
        a:"The one that smells like fresh printer ink.",
        opts:["The one with the coffee ring.","The one that smells like fresh printer ink.","Both essays.","Neither essay."]},

      // ===== UPPER (b ~ +0.6..+1.3) =====
      {id:"u01", b:0.6, type:"CLOZE", q:"The results were unclear; ___ , we repeated the test.", a:"therefore", opts:["therefore","maybe","rarely","quietly"]},
      {id:"u02", b:0.7, type:"TEXT_Q",
        story:`After the meeting, the manager says, ‚ÄúThat‚Äôs‚Ä¶ bold,‚Äù and closes the laptop.
No one speaks for a moment.`,
        q:"What is the manager most likely implying?",
        a:"They are not fully impressed / they are skeptical.",
        opts:[
          "They are not fully impressed / they are skeptical.",
          "They are extremely happy and celebrating.",
          "They did not hear the idea at all.",
          "They want to buy a laptop."
        ]},
      {id:"u03", b:0.8, type:"CLOZE", q:"She was ___ to speak in public at first.", a:"reluctant", opts:["reluctant","relevant","regular","remote"]},
      {id:"u04", b:0.9, type:"TEXT_Q",
        story:`A traveler asks for a caf√© that ‚Äúdoesn‚Äôt try too hard.‚Äù
The local points to a place with no sign and mismatched chairs.
The traveler goes to a neon place with fancy slogans.`,
        q:"Did the traveler follow the advice?",
        a:"No ‚Äî they chose the opposite kind of place.",
        opts:["Yes ‚Äî clearly.","No ‚Äî they chose the opposite kind of place.","Yes ‚Äî because it had chairs.","Not enough information."]},
      {id:"u05", b:1.0, type:"INFER",
        story:`A friend texts: ‚ÄúGreat, exactly what I needed üôÉ.‚Äù`,
        q:"What is the tone most likely?",
        a:"Sarcastic / not truly positive.",
        opts:["Very grateful.","Sarcastic / not truly positive.","Purely factual.","Confused and asking a question."]},
      {id:"u06", b:1.1, type:"TEXT_Q",
        story:`A reviewer writes: ‚ÄúThe plot moves like fog‚Äîeverywhere and going nowhere.
The language, however, cuts like glass.‚Äù`,
        q:"What did the reviewer like and dislike?",
        a:"Liked the writing style; disliked the plot.",
        opts:["Liked the plot; disliked the language.","Liked the writing style; disliked the plot.","Disliked both.","Liked both."]},
      {id:"u07", b:1.2, type:"CLOZE", q:"He spoke ___ , choosing each word carefully.", a:"deliberately", opts:["deliberately","deliciously","deeply","daily"]},
      {id:"u08", b:1.3, type:"TEXT_Q",
        story:`The vendor replies immediately with a replacement link.
Later, the customer posts: ‚ÄúNo response from the seller.‚Äù`,
        q:"What does this suggest?",
        a:"The review is likely unfair or the customer missed the reply.",
        opts:[
          "The review is likely unfair or the customer missed the reply.",
          "The seller never replied.",
          "The customer is definitely right.",
          "The link was a scam (certainly)."
        ]},

      // ===== HARD (b ~ +1.4..+2.1) =====
      {id:"h01", b:1.4, type:"INFER",
        story:`The cat hides when it hears the vacuum.
Today the vacuum stayed in the closet, but the floor is clean.
The robot mop is quiet unless it gets stuck; then it makes a loud whir that sounds like a vacuum.`,
        q:"What likely startled the cat?",
        a:"The robot mop got stuck and made a loud whir.",
        opts:["The vacuum was used all day.","Thunder outside.","The robot mop got stuck and made a loud whir.","A bird sang."]},
      {id:"h02", b:1.6, type:"INFER",
        story:`Two siblings both claim they cleaned the kitchen.
The stove smells of lemon. The quiet sibling hates lemon cleaner.
The trash is tied but still in the bin. The chatty sibling often forgets to take out trash.`,
        q:"Who most likely cleaned, and why?",
        a:"The chatty sibling; lemon smell + trash still in the bin.",
        opts:[
          "The quiet sibling; dry sponge.",
          "The chatty sibling; lemon smell + trash still in the bin.",
          "Both; it‚Äôs impossible to tell.",
          "Neither; the kitchen is dirty."
        ]},
      {id:"h03", b:1.8, type:"TEXT_Q",
        story:`A note says: ‚ÄúI returned the book you never lent me.‚Äù
The librarian scans a novel and places it on the found shelf under your name.`,
        q:"What likely happened?",
        a:"Someone returned a book connected to you, and the note is ironic.",
        opts:[
          "Someone returned a book connected to you, and the note is ironic.",
          "You definitely stole a book.",
          "The librarian is joking about scanning machines.",
          "Nothing happened; it‚Äôs random."
        ]},
      {id:"h04", b:2.0, type:"INFER",
        story:`In a meeting, the manager says, ‚ÄúThat‚Äôs‚Ä¶ bold,‚Äù and shuts the laptop.
Later that day, a competitor announces a similar feature, and the idea is suddenly approved.`,
        q:"Why did the manager‚Äôs decision change?",
        a:"Competitive pressure made the idea urgent.",
        opts:[
          "They forgot the idea until later.",
          "Competitive pressure made the idea urgent.",
          "They got a new laptop.",
          "They disliked the competitor, so they cancelled it."
        ]},
    ];

    // 10+ per bucket
    const CARTOONS = {
      START: [
        ["Pocoyo","Very clear + simple situations"],
        ["Peppa Pig","Repetition + everyday topics"],
        ["Daniel Tiger‚Äôs Neighborhood","Slow, educational speech"],
        ["Dora the Explorer","Repeats a lot"],
        ["Sesame Street","Short sketches"],
        ["WordWorld","Very clear vocabulary"],
        ["Fireman Sam","Clear pronunciation"],
        ["Postman Pat","Predictable stories"],
        ["Sarah & Duck","Calm pace"],
        ["Paw Patrol","Simple action language"],
        ["Bluey","Still easy, but more natural"],
        ["Octonauts","Easy step up"],
      ],
      EASY: [
        ["Ben & Holly‚Äôs Little Kingdom","Richer than Peppa, still clear"],
        ["Curious George","Context helps a lot"],
        ["Arthur","School + everyday topics"],
        ["Mickey Mouse Clubhouse","Clear commands"],
        ["Max & Ruby","Daily life"],
        ["Bluey","Natural but very learnable"],
        ["Octonauts","Gentle vocab expansion"],
        ["Dora the Explorer","Repetition"],
        ["Peppa Pig","Solid base builder"],
        ["Sesame Street","Vocabulary in chunks"],
        ["Paw Patrol","Strong base"],
        ["Sarah & Duck","Calm pace + context"],
      ],
      MID: [
        ["Avatar: The Last Airbender","Story + clear speech"],
        ["Hilda","Good context, calmer pace"],
        ["Steven Universe","Context-heavy"],
        ["Gravity Falls","Humor + story (sometimes fast)"],
        ["Adventure Time","Varied voices"],
        ["We Bare Bears","Modern everyday language"],
        ["Phineas and Ferb","Fast but repetitive structure"],
        ["Teen Titans Go!","Fast but short lines"],
        ["The Dragon Prince","More dialogue, story-driven"],
        ["How to Train Your Dragon (series)","More vocabulary"],
        ["Kung Fu Panda (series)","Action but understandable"],
        ["Regular Show","Bridge upward"],
      ],
      HARD: [
        ["The Simpsons","References + speed"],
        ["Futurama","Jokes + tech words"],
        ["Family Guy","Fast + references"],
        ["South Park","Slang + character voices"],
        ["Disenchantment","Unusual humor"],
        ["Bojack Horseman","Dialogue-heavy sarcasm"],
        ["Rick and Morty","Very fast"],
        ["Archer","Fast sarcasm"],
        ["Arcane","Adult speech, fewer repeats"],
        ["Invincible","Dialogue-heavy"],
        ["Inside Job","Fast jokes"],
        ["The Amazing World of Gumball","Humor + speed"],
      ]
    };

    // ============================
    // DOM
    // ============================
    const $ = (id) => document.getElementById(id);

    // ============================
    // Posterior grid
    // ============================
    function makeGrid(){
      const xs = [];
      for(let t=-3.0; t<=3.0001; t+=0.05) xs.push(+t.toFixed(2));
      const w = xs.map(x => Math.exp(-0.5*x*x)); // N(0,1) prior (unnormalized)
      return {xs, w};
    }
    function logistic(z){ return 1 / (1 + Math.exp(-z)); }
    function pCorrect(theta, b){ return logistic(A * (theta - b)); }

    function normalize(arr){
      const s = arr.reduce((a,b)=>a+b,0);
      if (s <= 0) return arr.map(_=>1/arr.length);
      return arr.map(v=>v/s);
    }
    function meanAndSD(xs, w){
      const s = w.reduce((a,b)=>a+b,0);
      const m = xs.reduce((acc,x,i)=>acc + x*w[i], 0) / s;
      const v = xs.reduce((acc,x,i)=>acc + (x-m)*(x-m)*w[i], 0) / s;
      return {mean:m, sd:Math.sqrt(Math.max(1e-9, v))};
    }
    function confLabel(sd){
      if (sd <= 0.30) return "High";
      if (sd <= 0.45) return "Medium";
      return "Low";
    }

    // ============================
    // Adaptive state
    // ============================
    let state = null;

    function toast(msg){
      const t = $("toastMini");
      t.textContent = msg;
      t.style.display = "block";
      clearTimeout(toast._tm);
      toast._tm = setTimeout(()=> t.style.display="none", 1500);
    }
    function ytSearchUrl(title){
      return "https://www.youtube.com/results?search_query=" + encodeURIComponent(title + " english full episodes");
    }
    function fmtDate(iso){
      try{
        const d = new Date(iso);
        return d.toLocaleString("en-GB", { year:"numeric", month:"2-digit", day:"2-digit", hour:"2-digit", minute:"2-digit" });
      }catch(e){ return ""; }
    }
    function closeNavIfOpen(){
      const nav = $("navMain");
      if (nav && nav.classList.contains("show")){
        bootstrap.Collapse.getOrCreateInstance(nav).hide();
      }
    }

    function levelFromTheta(theta){
      // tuned for cartoon-selection, not CEFR exam
      if (theta < -1.05) return {key:"START", name:"START", badge:"badge-ok", explain:"Very simple cartoons with strong repetition."};
      if (theta < -0.25) return {key:"EASY",  name:"EASY",  badge:"badge-ok", explain:"Kids shows with clear speech and lots of context."};
      if (theta < 0.65)  return {key:"MID",   name:"MID",   badge:"badge-mid", explain:"Story-driven cartoons; keep it 60‚Äì80% clear."};
      return               {key:"HARD",  name:"HARD",  badge:"badge-hard", explain:"Faster dialogue, jokes, references."};
    }

    function initTest(){
      const {xs, w} = makeGrid();
      // clone bank, mark unasked
      const items = ITEM_BANK.map(it => ({...it, _asked:false}));

      state = {
        xs,
        post: normalize(w.slice()),
        items,
        asked: 0,
        correct: 0,
        locked: false,
        current: null,
        history: [],
      };

      $("testRow").style.display = "";
      $("resultRow").style.display = "none";
      updateTopStats();
      nextQuestion(true);
    }

    function updatePosterior(isCorrect, item){
      // Bayesian update on grid
      const xs = state.xs;
      const post = state.post;
      for(let i=0;i<xs.length;i++){
        const p = pCorrect(xs[i], item.b);
        post[i] *= (isCorrect ? p : (1 - p));
      }
      state.post = normalize(post);
    }

    function selectNextItem(){
      const remaining = state.items.filter(it => !it._asked);
      if (!remaining.length) return null;

      const ms = meanAndSD(state.xs, state.post);
      const thetaHat = ms.mean;

      // pick item with b closest to thetaHat (max info near p=0.5)
      let best = null;
      let bestScore = -Infinity;

      for (const it of remaining){
        const p = pCorrect(thetaHat, it.b);
        const info = p * (1 - p);          // highest near 0.25
        const closeness = -Math.abs(it.b - thetaHat); // closer is better
        // weighted score: closeness dominates, info breaks ties
        const score = closeness * 10 + info;
        if (score > bestScore){
          bestScore = score;
          best = it;
        }
      }
      return best;
    }

    function shouldStop(){
      const ms = meanAndSD(state.xs, state.post);
      // Early stop rules:
      // 1) at least MIN_Q
      // 2) confident enough OR reached MAX_Q OR bank exhausted
      if (state.asked < MIN_Q) return false;
      if (ms.sd <= TARGET_SD) return true;
      if (state.asked >= MAX_Q) return true;
      return false;
    }

    function updateTopStats(){
      const ms = meanAndSD(state.xs, state.post);
      const acc = state.asked ? Math.round((state.correct/state.asked)*100) : 0;
      $("progressText").textContent = state.asked + "/" + MAX_Q + " (stops early)";
      $("accuracyText").textContent = "accuracy: " + (state.asked ? acc + "%" : "‚Äî");
      $("confText").textContent = "confidence: " + confLabel(ms.sd);

      const pct = Math.min(100, Math.round((state.asked / MAX_Q) * 100));
      $("progressBar").style.width = pct + "%";

      $("estBadge").textContent = "estimate: " + ms.mean.toFixed(2);
      $("sdBadge").textContent = "¬± " + ms.sd.toFixed(2);
    }

    function renderQuestion(item){
      state.current = item;
      state.locked = false;

      $("typeBadge").textContent =
        "type: " + (item.type === "CLOZE" ? "choose word" : (item.type === "INFER" ? "inference" : "read & answer"));

      $("qTitle").textContent = item.q;
      $("qSub").textContent =
        item.type === "CLOZE" ? "Choose the best word." :
        item.type === "INFER" ? "Choose the best meaning." :
        "Read the text and answer the question.";

      if (item.story){
        $("storyBox").style.display = "";
        $("storyBox").textContent = item.story;
      } else {
        $("storyBox").style.display = "none";
        $("storyBox").textContent = "";
      }

      // shuffle options without mutating original
      const opts = item.opts.slice();
      for (let i = opts.length - 1; i > 0; i--){
        const j = Math.floor(Math.random() * (i + 1));
        [opts[i], opts[j]] = [opts[j], opts[i]];
      }

      const grid = $("answersGrid");
      grid.innerHTML = "";
      opts.forEach((opt, i)=>{
        const btn = document.createElement("button");
        btn.type = "button";
        btn.className = "ans-btn";
        btn.textContent = (i+1) + ") " + opt;
        btn.addEventListener("click", ()=> answer(opt === item.a, btn));
        grid.appendChild(btn);
      });

      updateTopStats();
    }

    function disableAnswers(){
      $("answersGrid").querySelectorAll("button").forEach(b => b.disabled = true);
    }

    function answer(isCorrect, clicked){
      if (state.locked) return;
      state.locked = true;

      const item = state.current;
      disableAnswers();

      // mark correct option
      $("answersGrid").querySelectorAll("button").forEach(btn=>{
        const txt = btn.textContent.replace(/^\d+\)\s*/, "").trim();
        if (txt === item.a) btn.classList.add("ans-correct");
      });

      if (isCorrect){
        clicked.classList.add("ans-correct");
        state.correct++;
        toast("Correct ‚úÖ");
      } else {
        clicked.classList.add("ans-wrong");
        toast("Wrong ‚ùå");
      }

      item._asked = true;
      state.asked++;
      state.history.push({id:item.id, b:item.b, type:item.type, ok:isCorrect});

      updatePosterior(isCorrect, item);
      updateTopStats();

      setTimeout(()=> nextQuestion(false), 550);
    }

    function skip(){
      if (!state || state.locked) return;
      // treat as incorrect (safer for recommendations)
      const item = state.current;
      disableAnswers();
      $("answersGrid").querySelectorAll("button").forEach(btn=>{
        const txt = btn.textContent.replace(/^\d+\)\s*/, "").trim();
        if (txt === item.a) btn.classList.add("ans-correct");
      });

      item._asked = true;
      state.asked++;
      state.history.push({id:item.id, b:item.b, type:item.type, ok:false, skip:true});

      updatePosterior(false, item);
      updateTopStats();

      toast("Skipped");
      setTimeout(()=> nextQuestion(false), 550);
    }

    function nextQuestion(isFirst){
      if (!state) return;

      if (!isFirst && shouldStop()){
        finish("Stopped early (enough signal).");
        return;
      }

      const next = selectNextItem();
      if (!next){
        finish("No more questions.");
        return;
      }
      renderQuestion(next);
    }

    // ============================
    // RESULT + SAVE
    // ============================
    function renderRecommendations(levelKey){
      const list = (CARTOONS[levelKey] || []).slice(0, 12);
      const grid = $("recGrid");
      grid.innerHTML = "";
      list.forEach(([title, note])=>{
        const col = document.createElement("div");
        col.className = "col-12 col-md-6 col-xl-4";
        col.innerHTML = `
          <div class="show-card">
            <div class="title">${title}</div>
            <p class="desc">${note}</p>
            <div class="d-flex gap-2 flex-wrap mt-auto">
              <a class="btn btn-soft btn-sm" target="_blank" rel="noopener" href="${ytSearchUrl(title)}">Search on YouTube ‚Üó</a>
            </div>
          </div>
        `;
        grid.appendChild(col);
      });
    }

    function finish(note){
      const ms = meanAndSD(state.xs, state.post);
      const level = levelFromTheta(ms.mean);
      const acc = state.asked ? Math.round((state.correct/state.asked)*100) : 0;

      const obj = {
        savedAt: new Date().toISOString(),
        note,
        thetaMean: ms.mean,
        thetaSD: ms.sd,
        confidence: confLabel(ms.sd),
        level,
        asked: state.asked,
        correct: state.correct,
        accuracy: acc,
        history: state.history
      };

      save(obj);
      showResult(obj);
    }

    function save(obj){
      localStorage.setItem(KEY, JSON.stringify(obj));
      $("savedHint").style.display = "block";
      $("savedHint").textContent = "Saved: " + fmtDate(obj.savedAt);
    }
    function load(){
      try{ return JSON.parse(localStorage.getItem(KEY)); }catch(e){ return null; }
    }
    function clearCache(){
      localStorage.removeItem(KEY);
      $("savedHint").style.display = "none";
      toast("Cache cleared");
    }

    function showResult(obj){
      $("testRow").style.display = "none";
      $("resultRow").style.display = "";
      $("btnStart").textContent = "Start";

      $("resultMeta").textContent = `${obj.note} ‚Ä¢ Saved: ${fmtDate(obj.savedAt)} ‚Ä¢ estimate=${obj.thetaMean.toFixed(2)} ¬± ${obj.thetaSD.toFixed(2)}`;

      $("levelName").textContent = obj.level.name;
      $("levelName").className = "h3 fw-bold mb-1 " + obj.level.badge;
      $("levelExplain").textContent = obj.level.explain;

      $("finalConf").textContent = obj.confidence;
      $("finalSD").textContent = "uncertainty: ¬± " + obj.thetaSD.toFixed(2) + " (lower = better)";

      $("finalAccuracy").textContent = obj.accuracy + "%";
      $("finalCount").textContent = obj.correct + " / " + obj.asked + " answered";

      renderRecommendations(obj.level.key);

      // top bar
      $("progressText").textContent = obj.asked + " questions (adaptive)";
      $("accuracyText").textContent = "accuracy: " + obj.accuracy + "%";
      $("confText").textContent = "confidence: " + obj.confidence;
      $("progressBar").style.width = "100%";
    }

    // ============================
    // INIT
    // ============================
    (function init(){
      const saved = load();
      if (saved && saved.savedAt){
        $("savedHint").style.display = "block";
        $("savedHint").textContent = "Last saved: " + fmtDate(saved.savedAt);
        showResult(saved);
      }

      $("btnStart").addEventListener("click", ()=>{
        closeNavIfOpen();
        $("resultRow").style.display = "none";
        initTest();
        toast("Go!");
      });

      $("btnSkip").addEventListener("click", skip);

      $("btnRestart").addEventListener("click", ()=>{
        closeNavIfOpen();
        $("resultRow").style.display = "none";
        initTest();
      });

      $("btnRetake").addEventListener("click", ()=>{
        $("resultRow").style.display = "none";
        initTest();
        window.scrollTo({top:0, behavior:"smooth"});
      });

      $("btnSaveNow").addEventListener("click", ()=>{
        const saved = load();
        if (saved){
          saved.savedAt = new Date().toISOString();
          save(saved);
          toast("Saved");
        } else toast("Nothing to save yet");
      });

      $("btnShowSaved").addEventListener("click", ()=>{
        closeNavIfOpen();
        const saved = load();
        if (!saved){ toast("No saved result"); return; }
        showResult(saved);
        window.scrollTo({top:0, behavior:"smooth"});
      });

      $("btnClear").addEventListener("click", ()=>{
        closeNavIfOpen();
        if (confirm("Clear saved result?")){
          clearCache();
          $("resultRow").style.display = "none";
          $("testRow").style.display = "none";
          $("progressBar").style.width = "0%";
          $("progressText").textContent = "0/0";
          $("accuracyText").textContent = "accuracy: ‚Äî";
          $("confText").textContent = "confidence: ‚Äî";
        }
      });
    })();
  </script>
</body>
</html>
